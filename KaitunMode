(function() {
    'use strict';

    const STORAGE_KEY = 'eduso_auto_state';
    const ANSWER_KEY = 'eduso_current_answers';
    const HOME_URL = 'https://eduso.vn/thcs-chau-can/student';

    // ============================================
    // PH·∫¶N 1: TRANG CH·ª¶ - Qu√©t v√† b·∫Øt ƒë·∫ßu
    // ============================================
    if (location.href === HOME_URL) {
        initHomePage();
    }

    // ============================================
    // PH·∫¶N 2: TRANG L√ÄM B√ÄI - X·ª≠ l√Ω 2 tr∆∞·ªùng h·ª£p
    // ============================================
    else if (location.pathname.includes('/practice/detail/')) {
        initPracticePage();
    }

    // ============================================
    // PH·∫¶N 3: TRANG ƒê√ÅP √ÅN - Qu√©t ƒë√°p √°n v√† quay l·∫°i
    // ============================================
    else if (location.pathname.includes('/Practice/ReviewLessonExam/')) {
        initReviewPage();
    }

    // ================================================
    // TRANG CH·ª¶: UI + Qu√©t b√†i + B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông
    // ================================================
    function initHomePage() {
        // X√ìA C√ÅC FLAG C≈® KHI V·ªÄ TRANG CH·ª¶
        cleanupSessionFlags();

        createUI();

        const state = getState();
        if (state && state.isRunning) {
            // Ti·∫øp t·ª•c t·ª´ b√†i ti·∫øp theo
            setTimeout(() => {
                continueAutoProcess();
            }, 1000);
        }
    }

    function cleanupSessionFlags() {
        // X√≥a t·∫•t c·∫£ c√°c flag t·∫°m th·ªùi khi v·ªÅ trang ch·ªß
        sessionStorage.removeItem('eduso_auto_fill');
        sessionStorage.removeItem('eduso_practice_url');
        sessionStorage.removeItem(ANSWER_KEY);
        console.log('[AUTO] üßπ ƒê√£ x√≥a c√°c flag session c≈©');
    }

    function createUI() {
        const btn = document.createElement('button');
        btn.id = 'edusoFullAutoBtn';
        btn.innerHTML = 'üöÄ T·ª± ƒê·ªông L√ÄM TO√ÄN B·ªò B√ÄI';
        btn.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 999999;
            padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; font-size: 14px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            font-family: sans-serif; transition: all 0.3s;
        `;
        btn.onmouseenter = () => btn.style.transform = 'scale(1.05)';
        btn.onmouseleave = () => btn.style.transform = 'scale(1)';
        document.body.appendChild(btn);

        // Panel hi·ªÉn th·ªã tr·∫°ng th√°i
        const panel = document.createElement('div');
        panel.id = 'edusoAutoPanel';
        panel.style.cssText = `
            position: fixed; top: 70px; right: 20px; width: 320px;
            background: rgba(10, 10, 30, 0.95); backdrop-filter: blur(10px);
            color: white; padding: 16px; border-radius: 12px;
            z-index: 999998; font-family: sans-serif; display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        `;
        panel.innerHTML = `
            <h3 style="margin: 0 0 12px; color: #667eea;">üìä Tr·∫°ng Th√°i T·ª± ƒê·ªông</h3>
            <div id="autoStatus" style="font-size: 13px; line-height: 1.8;">
                <div>T·ªïng b√†i: <span id="totalCount" style="color: #ffd93d; font-weight: bold;">0</span></div>
                <div>C·∫ßn l√†m: <span id="pendingCount" style="color: #ff6b6b; font-weight: bold;">0</span></div>
                <div>ƒê√£ ho√†n th√†nh: <span id="doneCount" style="color: #51cf66; font-weight: bold;">0</span></div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="color: #aaa; font-size: 11px; margin-bottom: 4px;">ƒêang x·ª≠ l√Ω:</div>
                    <div id="currentTask" style="color: #ffd93d; font-weight: bold; font-size: 13px;">Ch∆∞a b·∫Øt ƒë·∫ßu</div>
                </div>
            </div>
            <button id="stopAutoBtn" style="
                width: 100%; margin-top: 12px; padding: 10px;
                background: #ff6b6b; color: white; border: none;
                border-radius: 6px; font-weight: bold; cursor: pointer;
                display: none; transition: all 0.3s;
            ">‚è∏ D·ª™NG L·∫†I</button>
        `;
        document.body.appendChild(panel);

        btn.onclick = () => {
            startAutoProcess();
        };

        const stopBtn = document.getElementById('stopAutoBtn');
        stopBtn.onclick = () => {
            stopAutoProcess();
        };
        stopBtn.onmouseenter = () => stopBtn.style.background = '#ff5252';
        stopBtn.onmouseleave = () => stopBtn.style.background = '#ff6b6b';
    }

    function startAutoProcess() {
        const lessons = scanAllLessons();
        const pending = lessons.filter(l => l.type === 'pending');

        if (pending.length === 0) {
            alert('‚úÖ T·∫•t c·∫£ b√†i ƒë√£ ho√†n th√†nh!');
            return;
        }

        const state = {
            isRunning: true,
            lessons: lessons,
            currentIndex: 0,
            totalCount: lessons.length,
            pendingCount: pending.length,
            doneCount: lessons.length - pending.length
        };

        saveState(state);

        const panel = document.getElementById('edusoAutoPanel');
        panel.style.display = 'block';

        document.getElementById('stopAutoBtn').style.display = 'block';
        updateStatusUI(state);

        // B·∫Øt ƒë·∫ßu v·ªõi b√†i ƒë·∫ßu ti√™n
        processNextLesson(state);
    }

    function continueAutoProcess() {
        const state = getState();
        if (!state || !state.isRunning) return;

        const panel = document.getElementById('edusoAutoPanel');
        panel.style.display = 'block';
        document.getElementById('stopAutoBtn').style.display = 'block';

        // Qu√©t l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªõi
        const lessons = scanAllLessons();
        state.lessons = lessons;
        state.doneCount = lessons.filter(l => l.type === 'done').length;
        state.pendingCount = lessons.filter(l => l.type === 'pending').length;

        saveState(state);
        updateStatusUI(state);

        // T√¨m b√†i ti·∫øp theo c·∫ßn l√†m
        setTimeout(() => {
            processNextLesson(state);
        }, 500);
    }

    function processNextLesson(state) {
        // T√¨m b√†i ti·∫øp theo ch∆∞a l√†m
        let nextLesson = null;
        let nextIndex = -1;

        for (let i = 0; i < state.lessons.length; i++) {
            if (state.lessons[i].type === 'pending') {
                nextLesson = state.lessons[i];
                nextIndex = i;
                break;
            }
        }

        if (!nextLesson) {
            // Ho√†n th√†nh t·∫•t c·∫£
            finishAutoProcess();
            return;
        }

        // C·∫≠p nh·∫≠t state
        state.currentIndex = nextIndex;
        state.currentLesson = nextLesson.title;
        saveState(state);

        // C·∫≠p nh·∫≠t UI
        document.getElementById('currentTask').textContent = `${nextLesson.title}`;

        console.log(`[AUTO] üéØ B·∫Øt ƒë·∫ßu x·ª≠ l√Ω b√†i ${nextIndex + 1}/${state.totalCount}: ${nextLesson.title}`);

        // M·ªü b√†i
        setTimeout(() => {
            const items = document.querySelectorAll('div.flex.cursor-pointer');
            const targetElement = items[nextIndex];
            if (targetElement) {
                targetElement.click();
                console.log(`[AUTO] ‚úÖ ƒê√£ click m·ªü b√†i: ${nextLesson.title}`);
            } else {
                console.error('[AUTO] ‚ùå Kh√¥ng t√¨m th·∫•y element b√†i t·∫≠p');
            }
        }, 800);
    }

    function scanAllLessons() {
        const items = document.querySelectorAll('div.flex.cursor-pointer');
        const lessons = [];

        items.forEach((el, idx) => {
            const titleEl = el.querySelector('div.text-base');
            const statusEl = el.querySelector('span.text-sm.font-bold');
            if (!titleEl || !statusEl) return;

            const title = titleEl.textContent.trim();
            let statusText = statusEl.textContent.trim();

            let score = null;
            let type = '';

            if (statusText === 'Ch∆∞a th·ª±c hi·ªán') {
                score = 0;
                type = 'pending';
            } else if (/^\d+\.\d+$/.test(statusText)) {
                score = parseFloat(statusText);
                type = score <= 3.0 ? 'pending' : 'done';
            } else {
                type = 'unknown';
            }

            lessons.push({ index: idx, title, score, type });
        });

        return lessons;
    }

    function updateStatusUI(state) {
        document.getElementById('totalCount').textContent = state.totalCount;
        document.getElementById('pendingCount').textContent = state.pendingCount;
        document.getElementById('doneCount').textContent = state.doneCount;
        if (state.currentLesson) {
            document.getElementById('currentTask').textContent = state.currentLesson;
        }
    }

    function stopAutoProcess() {
        clearState();
        const panel = document.getElementById('edusoAutoPanel');
        panel.style.display = 'none';
        alert('‚è∏ ƒê√£ d·ª´ng qu√° tr√¨nh t·ª± ƒë·ªông');
        location.reload();
    }

    function finishAutoProcess() {
        clearState();
        document.getElementById('currentTask').textContent = '‚úÖ Ho√†n th√†nh t·∫•t c·∫£!';
        document.getElementById('stopAutoBtn').style.display = 'none';
        setTimeout(() => {
            alert('üéâ ƒê√£ ho√†n th√†nh t·∫•t c·∫£ b√†i t·∫≠p!');
            location.reload();
        }, 1000);
    }

    // ================================================
    // TRANG L√ÄM B√ÄI: 2 TR∆Ø·ªúNG H·ª¢P
    // ================================================
    function initPracticePage() {
        console.log('[AUTO] üìù ƒêang ·ªü trang l√†m b√†i');

        // Ki·ªÉm tra xem c√≥ ph·∫£i quay l·∫°i ƒë·ªÉ ƒëi·ªÅn ƒë√°p √°n kh√¥ng
        const shouldFillAnswer = sessionStorage.getItem('eduso_auto_fill');

        if (shouldFillAnswer === 'true') {
            console.log('[AUTO] ‚úèÔ∏è CH·∫æ ƒê·ªò: ƒêi·ªÅn ƒë√°p √°n v√† ho√†n th√†nh');
            handleFillAnswersMode();
        } else {
            console.log('[AUTO] üìñ CH·∫æ ƒê·ªò: L·∫•y ƒë√°p √°n');
            // L∆∞u link trang l√†m b√†i
            const practiceURL = location.href;
            sessionStorage.setItem('eduso_practice_url', practiceURL);
            console.log('[AUTO] üíæ ƒê√£ l∆∞u link l√†m b√†i:', practiceURL);

            handleGetAnswersMode();
        }
    }

    // CH·∫æ ƒê·ªò 1: L·∫§Y ƒê√ÅP √ÅN (l·∫ßn ƒë·∫ßu v√†o trang)
    function handleGetAnswersMode() {
        interceptConsoleReady();
    }

    function interceptConsoleReady() {
        const originalLog = console.log;
        let hasStarted = false;

        console.log = function(...args) {
            originalLog(...args);

            if (hasStarted) return;

            if (args.some(a => typeof a === 'string' && a.includes('ready!'))) {
                hasStarted = true;
                console.log('[AUTO] ‚úÖ Ph√°t hi·ªán ready!');

                setTimeout(() => {
                    tryGetAnswers();
                }, 800);
            }
        };

        // Backup: n·∫øu kh√¥ng th·∫•y ready sau 5s
        setTimeout(() => {
            if (!hasStarted) {
                hasStarted = true;
                console.log('[AUTO] ‚è∞ Timeout - b·∫Øt ƒë·∫ßu x·ª≠ l√Ω');
                tryGetAnswers();
            }
        }, 5000);
    }

    async function tryGetAnswers() {
        // T√¨m n√∫t "Xem ƒë√°p √°n"
        const answerBtn = findAnswerButton();

        if (answerBtn) {
            console.log('[AUTO] ‚úÖ T√¨m th·∫•y "Xem ƒë√°p √°n" - click ngay');
            clickAnswerButton(answerBtn);
        } else {
            console.log('[AUTO] ‚ö†Ô∏è Kh√¥ng c√≥ "Xem ƒë√°p √°n" - th·ª±c hi·ªán quy tr√¨nh l√†m b√†i ƒë·ªÉ m·ªü kh√≥a');
            await performExamFlowToUnlock();
        }
    }

    function findAnswerButton() {
        return Array.from(document.querySelectorAll('div, button, a, span, li'))
            .find(el => el.textContent?.trim() === 'Xem ƒë√°p √°n');
    }

    function clickAnswerButton(btn) {
        const onclick = btn.getAttribute('onclick') || '';
        const match = onclick.match(/Review\('([^']+)'\)/);

        if (match) {
            const id = match[1];
            const reviewURL = `/thcs-chau-can/student/Practice/ReviewLessonExam/${id}`;
            console.log('[AUTO] üîÄ Redirect ƒë·∫øn trang ƒë√°p √°n:', reviewURL);
            window.location.href = reviewURL;
        } else {
            btn.click();
            console.log('[AUTO] üîÄ Click n√∫t "Xem ƒë√°p √°n"');
        }
    }

    async function performExamFlowToUnlock() {
        console.log('[AUTO] üéØ B·∫Øt ƒë·∫ßu quy tr√¨nh l√†m b√†i ƒë·ªÉ m·ªü ƒë√°p √°n');

        // Tick checkbox
        const chk = document.getElementById('chkUsage');
        if (chk && !chk.checked) {
            chk.checked = true;
            chk.dispatchEvent(new Event('change', { bubbles: true }));
            if (typeof toggleDoButton === 'function') toggleDoButton();
            console.log('[AUTO] ‚úÖ ƒê√£ tick checkbox');
            await delay(300);
        }

        // Click "L√†m b√†i" l·∫ßn 1
        const btn1 = document.getElementById('btn-doExam');
        if (btn1 && !btn1.disabled) {
            btn1.click();
            console.log('[AUTO] ‚úÖ Click "L√†m b√†i" l·∫ßn 1');
            await delay(800);
        }

        // Click "L√†m b√†i" l·∫ßn 2
        const btn2 = Array.from(document.querySelectorAll('a[onclick*="doExamCode"]'))
            .find(el => el.textContent?.trim() === 'L√†m b√†i');
        if (btn2) {
            btn2.click();
            console.log('[AUTO] ‚úÖ Click "L√†m b√†i" l·∫ßn 2');
            await delay(1000);
        }

        // Click "N·ªôp b√†i"
        const submitBtn = document.querySelector('button.btnComplete[onclick*="CompleteExam"]');
        if (submitBtn) {
            submitBtn.click();
            console.log('[AUTO] ‚úÖ Click "N·ªôp b√†i"');
            await delay(1200);
        }

        // X√°c nh·∫≠n popup l·∫ßn 1
        await clickConfirmPopup('x√°c nh·∫≠n l·∫ßn 1');
        await delay(700);

        // X√°c nh·∫≠n popup l·∫ßn 2
        await clickConfirmPopup('x√°c nh·∫≠n l·∫ßn 2');

        console.log('[AUTO] ‚úÖ Ho√†n th√†nh quy tr√¨nh - ch·ªù chuy·ªÉn ƒë·∫øn ƒë√°p √°n');
    }

    async function clickConfirmPopup(label) {
        for (let i = 0; i < 10; i++) {
            const btn = document.querySelector('.swal2-container .swal2-confirm');
            if (btn) {
                await delay(250);
                btn.click();
                console.log(`[AUTO] ‚úÖ Click ${label}`);
                return true;
            }
            await delay(300);
        }
        console.log(`[AUTO] ‚≠ï Kh√¥ng th·∫•y ${label}`);
        return false;
    }

    // CH·∫æ ƒê·ªò 2: ƒêI·ªÄN ƒê√ÅP √ÅN V√Ä HO√ÄN TH√ÄNH
    async function handleFillAnswersMode() {
        console.log('[AUTO] üîÑ Ch·ªù trang s·∫µn s√†ng ƒë·ªÉ ƒëi·ªÅn ƒë√°p √°n...');

        // Ch·ªù trang load xong
        await delay(1500);

        // KI·ªÇM TRA ƒêI·ªÇM S·ªê - N·∫øu ƒë√£ ƒë·∫°t > 3.0 th√¨ b·ªè qua
        const currentScore = checkCurrentScore();
        if (currentScore !== null && currentScore > 3.0) {
            console.log(`[AUTO] ‚úÖ B√†i ƒë√£ ƒë·∫°t ${currentScore} ƒëi·ªÉm - B·ªè qua v√† quay v·ªÅ trang ch·ªß`);

            // X√≥a flag v√† quay v·ªÅ
            sessionStorage.removeItem('eduso_auto_fill');
            sessionStorage.removeItem('eduso_practice_url');
            sessionStorage.removeItem(ANSWER_KEY);

            await delay(1000);
            window.location.href = HOME_URL;
            return;
        }

        console.log('[AUTO] üìù ƒêi·ªÉm ch∆∞a ƒë·∫°t ho·∫∑c ch∆∞a l√†m - Ti·∫øp t·ª•c l√†m b√†i');

        // L·∫•y ƒë√°p √°n ƒë√£ l∆∞u
        const answersJSON = sessionStorage.getItem(ANSWER_KEY);
        if (!answersJSON) {
            console.error('[AUTO] ‚ùå Kh√¥ng t√¨m th·∫•y ƒë√°p √°n ƒë√£ l∆∞u!');
            alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y ƒë√°p √°n');
            return;
        }

        const ANSWERS = JSON.parse(answersJSON);
        console.log('[AUTO] ‚úÖ ƒê√£ load', ANSWERS.length, 'ƒë√°p √°n:', ANSWERS);

        // TH·ª∞C HI·ªÜN QUY TR√åNH L√ÄM L·∫†I B√ÄI
        console.log('[AUTO] üîÑ B·∫Øt ƒë·∫ßu quy tr√¨nh l√†m l·∫°i b√†i...');

        // B∆∞·ªõc 1: Tick checkbox
        const chk = document.getElementById('chkUsage');
        if (chk && !chk.checked) {
            chk.checked = true;
            chk.dispatchEvent(new Event('change', { bubbles: true }));
            if (typeof toggleDoButton === 'function') toggleDoButton();
            console.log('[AUTO] ‚úÖ ƒê√£ tick checkbox');
            await delay(500);
        }

        // B∆∞·ªõc 2: Click "L√†m b√†i" l·∫ßn 1
        const btn1 = document.getElementById('btn-doExam');
        if (btn1 && !btn1.disabled) {
            btn1.click();
            console.log('[AUTO] ‚úÖ Click "L√†m b√†i" l·∫ßn 1');
            await delay(1000);
        }

        // B∆∞·ªõc 3: Click "L√†m b√†i" l·∫ßn 2 (popup confirmation)
        const btn2 = Array.from(document.querySelectorAll('a[onclick*="doExamCode"]'))
            .find(el => el.textContent?.trim() === 'L√†m b√†i');
        if (btn2) {
            btn2.click();
            console.log('[AUTO] ‚úÖ Click "L√†m b√†i" l·∫ßn 2 (popup)');
            await delay(1500);
        }

        // B∆∞·ªõc 4: ƒêI·ªÄN ƒê√ÅP √ÅN
        await autoFillAnswers(ANSWERS);

        // X√ìA T·∫§T C·∫¢ FLAG SAU KHI HO√ÄN TH√ÄNH
        console.log('[AUTO] üßπ X√≥a c√°c flag sau khi ho√†n th√†nh b√†i');
        sessionStorage.removeItem('eduso_auto_fill');
        sessionStorage.removeItem('eduso_practice_url');
        sessionStorage.removeItem(ANSWER_KEY);

        // Sau khi ƒëi·ªÅn xong, quay v·ªÅ trang ch·ªß
        console.log('[AUTO] üè† Quay v·ªÅ trang ch·ªß ƒë·ªÉ ti·∫øp t·ª•c b√†i ti·∫øp theo...');
        await delay(2000);
        window.location.href = HOME_URL;
    }

    // H√†m ki·ªÉm tra ƒëi·ªÉm s·ªë hi·ªán t·∫°i tr√™n trang l√†m b√†i
    function checkCurrentScore() {
        try {
            // T√¨m t·∫•t c·∫£ c√°c <td> c√≥ style="user-select: text;"
            const tdElements = Array.from(document.querySelectorAll('td[style*="user-select: text"]'));

            if (tdElements.length >= 4) {
                // H√†ng th·ª© 4 (index 3) ch·ª©a ƒëi·ªÉm s·ªë
                const scoreText = tdElements[3].textContent.trim();
                const score = parseFloat(scoreText);

                if (!isNaN(score)) {
                    console.log(`[AUTO] üìä Ph√°t hi·ªán ƒëi·ªÉm s·ªë hi·ªán t·∫°i: ${score}`);
                    return score;
                }
            }

            console.log('[AUTO] ‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ƒëi·ªÉm s·ªë');
            return null;
        } catch (e) {
            console.error('[AUTO] ‚ùå L·ªói khi ki·ªÉm tra ƒëi·ªÉm:', e);
            return null;
        }
    }

    async function autoFillAnswers(ANSWERS) {
        console.log('[AUTO] ‚úèÔ∏è B·∫Øt ƒë·∫ßu ƒëi·ªÅn', ANSWERS.length, 'ƒë√°p √°n');

        const questions = document.querySelectorAll('.quiz-item');
        const total = questions.length;
        const speed = 400; // ms gi·ªØa m·ªói c√¢u

        let idx = 0;

        for (let i = 0; i < questions.length; i++) {
            const q = questions[i];

            // B·ªè qua c√¢u QUIZ3 (n·∫øu c√≥)
            if (q.querySelector('.answer-pane')?.dataset.type === 'QUIZ3') {
                console.log(`[AUTO] ‚≠ï B·ªè qua c√¢u ${i + 1} (QUIZ3)`);
                continue;
            }

            const ans = (ANSWERS[idx++] || '').trim();
            if (!ans) {
                console.log(`[AUTO] ‚ö†Ô∏è C√¢u ${i + 1}: Kh√¥ng c√≥ ƒë√°p √°n`);
                continue;
            }

            console.log(`[AUTO] üìù C√¢u ${i + 1}/${total}: ƒêi·ªÅn "${ans}"`);

            let success = false;

            // N·∫øu l√† ƒë√°p √°n tr·∫Øc nghi·ªám (A. B. C. D.)
            if (ans.endsWith('.')) {
                for (const fc of q.querySelectorAll('.form-check')) {
                    const lbl = fc.querySelector('label.answer-text');
                    if (lbl && lbl.textContent.trim().startsWith(ans)) {
                        success = safeClick(fc);
                        if (success) {
                            console.log(`[AUTO] ‚úÖ ƒê√£ ch·ªçn ${ans}`);
                        }
                        break;
                    }
                }
            }
            // N·∫øu l√† ƒë√°p √°n ƒëi·ªÅn (fill-in)
            else {
                const span = q.querySelector('span.fillquiz[contenteditable]');
                if (span) {
                    span.innerText = ans;
                    span.dispatchEvent(new Event('input', { bubbles: true }));
                    span.dispatchEvent(new Event('blur', { bubbles: true }));
                    success = true;
                    console.log(`[AUTO] ‚úÖ ƒê√£ ƒëi·ªÅn text "${ans}"`);
                }
            }

            if (!success) {
                console.log(`[AUTO] ‚ö†Ô∏è Kh√¥ng th·ªÉ ƒëi·ªÅn c√¢u ${i + 1}`);
            }

            // Delay gi·ªØa c√°c c√¢u
            await delay(speed);
        }

        console.log('[AUTO] ‚úÖ Ho√†n th√†nh ƒëi·ªÅn t·∫•t c·∫£ ƒë√°p √°n');

        // N·ªòP B√ÄI
        await delay(1000);
        console.log('[AUTO] üì§ B·∫Øt ƒë·∫ßu n·ªôp b√†i...');

        const submitBtn = document.querySelector('button.btnComplete[onclick*="CompleteExam"]');
        if (submitBtn) {
            submitBtn.click();
            console.log('[AUTO] ‚úÖ Click "N·ªôp b√†i"');
            await delay(1200);

            // X√°c nh·∫≠n popup
            await clickConfirmPopup('x√°c nh·∫≠n n·ªôp b√†i l·∫ßn 1');
            await delay(700);
            await clickConfirmPopup('x√°c nh·∫≠n n·ªôp b√†i l·∫ßn 2');

            console.log('[AUTO] ‚úÖ ƒê√£ n·ªôp b√†i th√†nh c√¥ng');
        } else {
            console.error('[AUTO] ‚ùå Kh√¥ng t√¨m th·∫•y n√∫t n·ªôp b√†i');
        }
    }

    function safeClick(el) {
        if (!el) return false;
        try {
            el.click();
            return true;
        } catch {
            const radio = el.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change', { bubbles: true }));
                radio.dispatchEvent(new Event('click', { bubbles: true }));
                return true;
            }
        }
        return false;
    }

    // ================================================
    // TRANG ƒê√ÅP √ÅN: Qu√©t ƒë√°p √°n v√† quay l·∫°i
    // ================================================
    function initReviewPage() {
        console.log('[AUTO] üìñ ƒêang ·ªü trang ƒë√°p √°n - b·∫Øt ƒë·∫ßu qu√©t');

        setTimeout(() => {
            const answers = scanAnswers();
            console.log('[AUTO] ‚úÖ ƒê√£ qu√©t ƒë∆∞·ª£c', answers.length, 'ƒë√°p √°n:', answers);

            // L∆∞u ƒë√°p √°n
            sessionStorage.setItem(ANSWER_KEY, JSON.stringify(answers));

            // Quay l·∫°i trang l√†m b√†i
            const practiceURL = sessionStorage.getItem('eduso_practice_url');
            if (practiceURL) {
                console.log('[AUTO] üîô Quay l·∫°i trang l√†m b√†i ƒë·ªÉ ƒëi·ªÅn ƒë√°p √°n:', practiceURL);
                sessionStorage.setItem('eduso_auto_fill', 'true'); // ƒê√°nh d·∫•u ch·∫ø ƒë·ªô ƒëi·ªÅn
                window.location.href = practiceURL;
            } else {
                console.error('[AUTO] ‚ùå Kh√¥ng t√¨m th·∫•y link trang l√†m b√†i ƒë√£ l∆∞u');
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y link trang l√†m b√†i');
            }
        }, 2000);
    }

    function scanAnswers() {
        const answers = [];
        const nodes = document.querySelectorAll('span.text-success, fillquiz i.text-success, fillquiz span.text-success');

        nodes.forEach(el => {
            let text = el.textContent.trim();
            if (!text || text.includes('Kh√¥ng c√≥')) return;
            if (text.includes('|')) text = text.split('|')[0].trim();

            if (el.tagName === 'SPAN' && /^[A-D][\.\)\s]/i.test(text)) {
                answers.push(text.charAt(0).toUpperCase() + ".");
            } else {
                answers.push(text);
            }
        });

        return answers;
    }

    // ================================================
    // STORAGE & HELPER FUNCTIONS
    // ================================================
    function saveState(state) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
            console.error('[AUTO] ‚ùå L·ªói l∆∞u state:', e);
        }
    }

    function getState() {
        try {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            return null;
        }
    }

    function clearState() {
        localStorage.removeItem(STORAGE_KEY);
        sessionStorage.removeItem('eduso_practice_url');
        sessionStorage.removeItem(ANSWER_KEY);
        sessionStorage.removeItem('eduso_auto_fill');
    }

    function delay(ms) {
        return new Promise(r => setTimeout(r, ms));
    }

})();

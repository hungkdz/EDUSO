(function() {
    'use strict';

    const STORAGE_KEY = 'eduso_auto_state';
    const ANSWER_KEY = 'eduso_current_answers';
    const COMPLETED_KEY = 'eduso_completed_lessons'; // TH√äM: Key l∆∞u danh s√°ch b√†i ƒë√£ ho√†n th√†nh
    const HOME_URL = 'https://eduso.vn/thcs-chau-can/student';

    // ============================================
    // PH·∫¶N 1: TRANG CH·ª¶ - Qu√©t v√† b·∫Øt ƒë·∫ßu
    // ============================================
    if (location.href === HOME_URL) {
        initHomePage();
    }

    // ============================================
    // PH·∫¶N 2: TRANG L√ÄM B√ÄI - X·ª≠ l√Ω 2 tr∆∞·ªùng h·ª£p
    // ============================================
    else if (location.pathname.includes('/practice/detail/')) {
        initPracticePage();
    }

    // ============================================
    // PH·∫¶N 3: TRANG ƒê√ÅP √ÅN - Qu√©t ƒë√°p √°n v√† quay l·∫°i
    // ============================================
    else if (location.pathname.includes('/Practice/ReviewLessonExam/')) {
        initReviewPage();
    }

    // ================================================
    // TRANG CH·ª¶: UI + Qu√©t b√†i + B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông
    // ================================================
    function initHomePage() {
        cleanupSessionFlags();
        createUI();

        const state = getState();
        if (state && state.isRunning) {
            setTimeout(() => {
                continueAutoProcess();
            }, 1000);
        }
    }

    function cleanupSessionFlags() {
        sessionStorage.removeItem('eduso_auto_fill');
        sessionStorage.removeItem('eduso_practice_url');
        sessionStorage.removeItem(ANSWER_KEY);
        console.log('[AUTO] üßπ ƒê√£ x√≥a c√°c flag session c≈©');
    }

    function createUI() {
        const btn = document.createElement('button');
        btn.id = 'edusoFullAutoBtn';
        btn.innerHTML = 'üöÄ T·ª± ƒê·ªông L√ÄM TO√ÄN B·ªò B√ÄI';
        btn.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 999999;
            padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; font-size: 14px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            font-family: sans-serif; transition: all 0.3s;
        `;
        btn.onmouseenter = () => btn.style.transform = 'scale(1.05)';
        btn.onmouseleave = () => btn.style.transform = 'scale(1)';
        document.body.appendChild(btn);

        const panel = document.createElement('div');
        panel.id = 'edusoAutoPanel';
        panel.style.cssText = `
            position: fixed; top: 70px; right: 20px; width: 320px;
            background: rgba(10, 10, 30, 0.95); backdrop-filter: blur(10px);
            color: white; padding: 16px; border-radius: 12px;
            z-index: 999998; font-family: sans-serif; display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        `;
        panel.innerHTML = `
            <h3 style="margin: 0 0 12px; color: #667eea;">üìä Tr·∫°ng Th√°i T·ª± ƒê·ªông</h3>
            <div id="autoStatus" style="font-size: 13px; line-height: 1.8;">
                <div>T·ªïng b√†i: <span id="totalCount" style="color: #ffd93d; font-weight: bold;">0</span></div>
                <div>C·∫ßn l√†m: <span id="pendingCount" style="color: #ff6b6b; font-weight: bold;">0</span></div>
                <div>ƒê√£ ho√†n th√†nh: <span id="doneCount" style="color: #51cf66; font-weight: bold;">0</span></div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="color: #aaa; font-size: 11px; margin-bottom: 4px;">ƒêang x·ª≠ l√Ω:</div>
                    <div id="currentTask" style="color: #ffd93d; font-weight: bold; font-size: 13px;">Ch∆∞a b·∫Øt ƒë·∫ßu</div>
                </div>
            </div>
            <button id="stopAutoBtn" style="
                width: 100%; margin-top: 12px; padding: 10px;
                background: #ff6b6b; color: white; border: none;
                border-radius: 6px; font-weight: bold; cursor: pointer;
                display: none; transition: all 0.3s;
            ">‚è∏ D·ª™NG L·∫†I</button>
        `;
        document.body.appendChild(panel);

        btn.onclick = () => {
            startAutoProcess();
        };

        const stopBtn = document.getElementById('stopAutoBtn');
        stopBtn.onclick = () => {
            stopAutoProcess();
        };
        stopBtn.onmouseenter = () => stopBtn.style.background = '#ff5252';
        stopBtn.onmouseleave = () => stopBtn.style.background = '#ff6b6b';
    }

    function startAutoProcess() {
        const lessons = scanAllLessons();
        const pending = lessons.filter(l => l.type === 'pending');

        if (pending.length === 0) {
            alert('‚úÖ T·∫•t c·∫£ b√†i ƒë√£ ho√†n th√†nh!');
            return;
        }

        const state = {
            isRunning: true,
            lessons: lessons,
            currentIndex: 0,
            totalCount: lessons.length,
            pendingCount: pending.length,
            doneCount: lessons.length - pending.length
        };

        saveState(state);

        const panel = document.getElementById('edusoAutoPanel');
        panel.style.display = 'block';

        document.getElementById('stopAutoBtn').style.display = 'block';
        updateStatusUI(state);

        processNextLesson(state);
    }

    function continueAutoProcess() {
        const state = getState();
        if (!state || !state.isRunning) return;

        const panel = document.getElementById('edusoAutoPanel');
        panel.style.display = 'block';
        document.getElementById('stopAutoBtn').style.display = 'block';

        const lessons = scanAllLessons();
        state.lessons = lessons;
        state.doneCount = lessons.filter(l => l.type === 'done').length;
        state.pendingCount = lessons.filter(l => l.type === 'pending').length;

        saveState(state);
        updateStatusUI(state);

        setTimeout(() => {
            processNextLesson(state);
        }, 500);
    }

    function processNextLesson(state) {
        // TH√äM: Ki·ªÉm tra danh s√°ch b√†i ƒë√£ ho√†n th√†nh
        const completedLessons = getCompletedLessons();
        
        let nextLesson = null;
        let nextIndex = -1;

        for (let i = 0; i < state.lessons.length; i++) {
            const lesson = state.lessons[i];
            
            // B·ªè qua b√†i ƒë√£ ƒë∆∞·ª£c ƒë√°nh d·∫•u ho√†n th√†nh trong session n√†y
            if (completedLessons.includes(lesson.title)) {
                console.log(`[AUTO] ‚è≠Ô∏è B·ªè qua b√†i ƒë√£ l√†m: ${lesson.title}`);
                continue;
            }
            
            if (lesson.type === 'pending') {
                nextLesson = lesson;
                nextIndex = i;
                break;
            }
        }

        if (!nextLesson) {
            finishAutoProcess();
            return;
        }

        state.currentIndex = nextIndex;
        state.currentLesson = nextLesson.title;
        saveState(state);

        document.getElementById('currentTask').textContent = `${nextLesson.title}`;

        console.log(`[AUTO] üéØ B·∫Øt ƒë·∫ßu x·ª≠ l√Ω b√†i ${nextIndex + 1}/${state.totalCount}: ${nextLesson.title}`);

        setTimeout(() => {
            const items = document.querySelectorAll('div.flex.cursor-pointer');
            const targetElement = items[nextIndex];
            if (targetElement) {
                targetElement.click();
                console.log(`[AUTO] ‚úÖ ƒê√£ click m·ªü b√†i: ${nextLesson.title}`);
            } else {
                console.error('[AUTO] ‚ùå Kh√¥ng t√¨m th·∫•y element b√†i t·∫≠p');
            }
        }, 800);
    }

    function scanAllLessons() {
        const items = document.querySelectorAll('div.flex.cursor-pointer');
        const lessons = [];

        items.forEach((el, idx) => {
            const titleEl = el.querySelector('div.text-base');
            const statusEl = el.querySelector('span.text-sm.font-bold');
            if (!titleEl || !statusEl) return;

            const title = titleEl.textContent.trim();
            let statusText = statusEl.textContent.trim();

            let score = null;
            let type = '';

            if (statusText === 'Ch∆∞a th·ª±c hi·ªán') {
                score = 0;
                type = 'pending';
            } else if (/^\d+\.\d+$/.test(statusText)) {
                score = parseFloat(statusText);
                type = score <= 3.0 ? 'pending' : 'done';
            } else {
                type = 'unknown';
            }

            lessons.push({ index: idx, title, score, type });
        });

        return lessons;
    }

    function updateStatusUI(state) {
        document.getElementById('totalCount').textContent = state.totalCount;
        document.getElementById('pendingCount').textContent = state.pendingCount;
        document.getElementById('doneCount').textContent = state.doneCount;
        if (state.currentLesson) {
            document.getElementById('currentTask').textContent = state.currentLesson;
        }
    }

    function stopAutoProcess() {
        clearState();
        clearCompletedLessons(); // TH√äM: X√≥a danh s√°ch b√†i ƒë√£ l√†m
        const panel = document.getElementById('edusoAutoPanel');
        panel.style.display = 'none';
        alert('‚è∏ ƒê√£ d·ª´ng qu√° tr√¨nh t·ª± ƒë·ªông');
        location.reload();
    }

    function finishAutoProcess() {
        clearState();
        clearCompletedLessons(); // TH√äM: X√≥a danh s√°ch b√†i ƒë√£ l√†m
        document.getElementById('currentTask').textContent = '‚úÖ Ho√†n th√†nh t·∫•t c·∫£!';
        document.getElementById('stopAutoBtn').style.display = 'none';
        setTimeout(() => {
            alert('üéâ ƒê√£ ho√†n th√†nh t·∫•t c·∫£ b√†i t·∫≠p!');
            location.reload();
        }, 1000);
    }

    // ================================================
    // TRANG L√ÄM B√ÄI: 2 TR∆Ø·ªúNG H·ª¢P
    // ================================================
    function initPracticePage() {
        console.log('[AUTO] üìù ƒêang ·ªü trang l√†m b√†i');

        const shouldFillAnswer = sessionStorage.getItem('eduso_auto_fill');

        if (shouldFillAnswer === 'true') {
            console.log('[AUTO] ‚úèÔ∏è CH·∫æ ƒê·ªò: ƒêi·ªÅn ƒë√°p √°n v√† ho√†n th√†nh');
            handleFillAnswersMode();
        } else {
            console.log('[AUTO] üìñ CH·∫æ ƒê·ªò: L·∫•y ƒë√°p √°n');
            const practiceURL = location.href;
            sessionStorage.setItem('eduso_practice_url', practiceURL);
            console.log('[AUTO] üíæ ƒê√£ l∆∞u link l√†m b√†i:', practiceURL);

            handleGetAnswersMode();
        }
    }

    function handleGetAnswersMode() {
        interceptConsoleReady();
    }

    function interceptConsoleReady() {
        const originalLog = console.log;
        let hasStarted = false;

        console.log = function(...args) {
            originalLog(...args);

            if (hasStarted) return;

            if (args.some(a => typeof a === 'string' && a.includes('ready!'))) {
                hasStarted = true;
                console.log('[AUTO] ‚úÖ Ph√°t hi·ªán ready!');

                setTimeout(() => {
                    tryGetAnswers();
                }, 800);
            }
        };

        setTimeout(() => {
            if (!hasStarted) {
                hasStarted = true;
                console.log('[AUTO] ‚è∞ Timeout - b·∫Øt ƒë·∫ßu x·ª≠ l√Ω');
                tryGetAnswers();
            }
        }, 5000);
    }

    async function tryGetAnswers() {
        const answerBtn = findAnswerButton();

        if (answerBtn) {
            console.log('[AUTO] ‚úÖ T√¨m th·∫•y "Xem ƒë√°p √°n" - click ngay');
            clickAnswerButton(answerBtn);
        } else {
            console.log('[AUTO] ‚ö†Ô∏è Kh√¥ng c√≥ "Xem ƒë√°p √°n" - th·ª±c hi·ªán quy tr√¨nh l√†m b√†i ƒë·ªÉ m·ªü kh√≥a');
            await performExamFlowToUnlock();
        }
    }

    function findAnswerButton() {
        return Array.from(document.querySelectorAll('div, button, a, span, li'))
            .find(el => el.textContent?.trim() === 'Xem ƒë√°p √°n');
    }

    function clickAnswerButton(btn) {
        const onclick = btn.getAttribute('onclick') || '';
        const match = onclick.match(/Review\('([^']+)'\)/);

        if (match) {
            const id = match[1];
            const reviewURL = `/thcs-chau-can/student/Practice/ReviewLessonExam/${id}`;
            console.log('[AUTO] üîÄ Redirect ƒë·∫øn trang ƒë√°p √°n:', reviewURL);
            window.location.href = reviewURL;
        } else {
            btn.click();
            console.log('[AUTO] üîÄ Click n√∫t "Xem ƒë√°p √°n"');
        }
    }

    async function performExamFlowToUnlock() {
        console.log('[AUTO] üéØ B·∫Øt ƒë·∫ßu quy tr√¨nh l√†m b√†i ƒë·ªÉ m·ªü ƒë√°p √°n');

        const chk = document.getElementById('chkUsage');
        if (chk && !chk.checked) {
            chk.checked = true;
            chk.dispatchEvent(new Event('change', { bubbles: true }));
            if (typeof toggleDoButton === 'function') toggleDoButton();
            console.log('[AUTO] ‚úÖ ƒê√£ tick checkbox');
            await delay(300);
        }

        const btn1 = document.getElementById('btn-doExam');
        if (btn1 && !btn1.disabled) {
            btn1.click();
            console.log('[AUTO] ‚úÖ Click "L√†m b√†i" l·∫ßn 1');
            await delay(800);
        }

        const btn2 = Array.from(document.querySelectorAll('a[onclick*="doExamCode"]'))
            .find(el => el.textContent?.trim() === 'L√†m b√†i');
        if (btn2) {
            btn2.click();
            console.log('[AUTO] ‚úÖ Click "L√†m b√†i" l·∫ßn 2');
            await delay(1000);
        }

        const submitBtn = document.querySelector('button.btnComplete[onclick*="CompleteExam"]');
        if (submitBtn) {
            submitBtn.click();
            console.log('[AUTO] ‚úÖ Click "N·ªôp b√†i"');
            await delay(1200);
        }

        await clickConfirmPopup('x√°c nh·∫≠n l·∫ßn 1');
        await delay(700);
        await clickConfirmPopup('x√°c nh·∫≠n l·∫ßn 2');

        console.log('[AUTO] ‚úÖ Ho√†n th√†nh quy tr√¨nh - ch·ªù chuy·ªÉn ƒë·∫øn ƒë√°p √°n');
    }

    async function clickConfirmPopup(label) {
        for (let i = 0; i < 10; i++) {
            const btn = document.querySelector('.swal2-container .swal2-confirm');
            if (btn) {
                await delay(250);
                btn.click();
                console.log(`[AUTO] ‚úÖ Click ${label}`);
                return true;
            }
            await delay(300);
        }
        console.log(`[AUTO] ‚≠ï Kh√¥ng th·∫•y ${label}`);
        return false;
    }

    async function handleFillAnswersMode() {
        console.log('[AUTO] üîÑ Ch·ªù trang s·∫µn s√†ng ƒë·ªÉ ƒëi·ªÅn ƒë√°p √°n...');

        await delay(1500);

        // L·∫§Y TH√îNG TIN B√ÄI HI·ªÜN T·∫†I
        const currentLessonTitle = getCurrentLessonTitle();
        console.log('[AUTO] üìö B√†i hi·ªán t·∫°i:', currentLessonTitle);

        // KI·ªÇM TRA XEM B√ÄI N√ÄY ƒê√É ƒê∆Ø·ª¢C X·ª¨ L√ù CH∆ØA
        if (isLessonCompleted(currentLessonTitle)) {
            console.log('[AUTO] ‚úÖ B√†i n√†y ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong session - B·ªè qua v√† quay v·ªÅ');
            
            sessionStorage.removeItem('eduso_auto_fill');
            sessionStorage.removeItem('eduso_practice_url');
            sessionStorage.removeItem(ANSWER_KEY);

            await delay(1000);
            window.location.href = HOME_URL;
            return;
        }

        // L·∫•y ƒë√°p √°n ƒë√£ l∆∞u
        const answersJSON = sessionStorage.getItem(ANSWER_KEY);
        if (!answersJSON) {
            console.error('[AUTO] ‚ùå Kh√¥ng t√¨m th·∫•y ƒë√°p √°n ƒë√£ l∆∞u!');
            alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y ƒë√°p √°n');
            return;
        }

        const ANSWERS = JSON.parse(answersJSON);
        console.log('[AUTO] ‚úÖ ƒê√£ load', ANSWERS.length, 'ƒë√°p √°n:', ANSWERS);

        console.log('[AUTO] üîÑ B·∫Øt ƒë·∫ßu quy tr√¨nh l√†m l·∫°i b√†i...');

        const chk = document.getElementById('chkUsage');
        if (chk && !chk.checked) {
            chk.checked = true;
            chk.dispatchEvent(new Event('change', { bubbles: true }));
            if (typeof toggleDoButton === 'function') toggleDoButton();
            console.log('[AUTO] ‚úÖ ƒê√£ tick checkbox');
            await delay(500);
        }

        const btn1 = document.getElementById('btn-doExam');
        if (btn1 && !btn1.disabled) {
            btn1.click();
            console.log('[AUTO] ‚úÖ Click "L√†m b√†i" l·∫ßn 1');
            await delay(1000);
        }

        const btn2 = Array.from(document.querySelectorAll('a[onclick*="doExamCode"]'))
            .find(el => el.textContent?.trim() === 'L√†m b√†i');
        if (btn2) {
            btn2.click();
            console.log('[AUTO] ‚úÖ Click "L√†m b√†i" l·∫ßn 2 (popup)');
            await delay(1500);
        }

        await autoFillAnswers(ANSWERS);

        // ƒê√ÅNH D·∫§U B√ÄI ƒê√É HO√ÄN TH√ÄNH
        markLessonAsCompleted(currentLessonTitle);
        console.log('[AUTO] ‚úÖ ƒê√£ ƒë√°nh d·∫•u b√†i ho√†n th√†nh:', currentLessonTitle);

        // X√ìA FLAG
        console.log('[AUTO] üßπ X√≥a c√°c flag sau khi ho√†n th√†nh b√†i');
        sessionStorage.removeItem('eduso_auto_fill');
        sessionStorage.removeItem('eduso_practice_url');
        sessionStorage.removeItem(ANSWER_KEY);

        console.log('[AUTO] üè† Quay v·ªÅ trang ch·ªß ƒë·ªÉ ti·∫øp t·ª•c b√†i ti·∫øp theo...');
        await delay(2000);
        window.location.href = HOME_URL;
    }

    // TH√äM: H√†m l·∫•y t√™n b√†i hi·ªán t·∫°i
    function getCurrentLessonTitle() {
        try {
            // Th·ª≠ t√¨m trong breadcrumb ho·∫∑c title
            const breadcrumb = document.querySelector('.breadcrumb-item.active, h1, h2, .lesson-title');
            if (breadcrumb) {
                return breadcrumb.textContent.trim();
            }

            // Fallback: l·∫•y t·ª´ URL
            const urlParts = location.pathname.split('/');
            return urlParts[urlParts.length - 1] || 'unknown';
        } catch (e) {
            console.error('[AUTO] ‚ùå L·ªói khi l·∫•y t√™n b√†i:', e);
            return 'unknown_' + Date.now();
        }
    }

    async function autoFillAnswers(ANSWERS) {
        console.log('[AUTO] ‚úèÔ∏è B·∫Øt ƒë·∫ßu ƒëi·ªÅn', ANSWERS.length, 'ƒë√°p √°n');

        const questions = document.querySelectorAll('.quiz-item');
        const total = questions.length;
        const speed = 400;

        let idx = 0;

        for (let i = 0; i < questions.length; i++) {
            const q = questions[i];

            if (q.querySelector('.answer-pane')?.dataset.type === 'QUIZ3') {
                console.log(`[AUTO] ‚≠ï B·ªè qua c√¢u ${i + 1} (QUIZ3)`);
                continue;
            }

            const ans = (ANSWERS[idx++] || '').trim();
            if (!ans) {
                console.log(`[AUTO] ‚ö†Ô∏è C√¢u ${i + 1}: Kh√¥ng c√≥ ƒë√°p √°n`);
                continue;
            }

            console.log(`[AUTO] üìù C√¢u ${i + 1}/${total}: ƒêi·ªÅn "${ans}"`);

            let success = false;

            if (ans.endsWith('.')) {
                for (const fc of q.querySelectorAll('.form-check')) {
                    const lbl = fc.querySelector('label.answer-text');
                    if (lbl && lbl.textContent.trim().startsWith(ans)) {
                        success = safeClick(fc);
                        if (success) {
                            console.log(`[AUTO] ‚úÖ ƒê√£ ch·ªçn ${ans}`);
                        }
                        break;
                    }
                }
            } else {
                const span = q.querySelector('span.fillquiz[contenteditable]');
                if (span) {
                    span.innerText = ans;
                    span.dispatchEvent(new Event('input', { bubbles: true }));
                    span.dispatchEvent(new Event('blur', { bubbles: true }));
                    success = true;
                    console.log(`[AUTO] ‚úÖ ƒê√£ ƒëi·ªÅn text "${ans}"`);
                }
            }

            if (!success) {
                console.log(`[AUTO] ‚ö†Ô∏è Kh√¥ng th·ªÉ ƒëi·ªÅn c√¢u ${i + 1}`);
            }

            await delay(speed);
        }

        console.log('[AUTO] ‚úÖ Ho√†n th√†nh ƒëi·ªÅn t·∫•t c·∫£ ƒë√°p √°n');

        await delay(1000);
        console.log('[AUTO] üì§ B·∫Øt ƒë·∫ßu n·ªôp b√†i...');

        const submitBtn = document.querySelector('button.btnComplete[onclick*="CompleteExam"]');
        if (submitBtn) {
            submitBtn.click();
            console.log('[AUTO] ‚úÖ Click "N·ªôp b√†i"');
            await delay(1200);

            await clickConfirmPopup('x√°c nh·∫≠n n·ªôp b√†i l·∫ßn 1');
            await delay(700);
            await clickConfirmPopup('x√°c nh·∫≠n n·ªôp b√†i l·∫ßn 2');

            console.log('[AUTO] ‚úÖ ƒê√£ n·ªôp b√†i th√†nh c√¥ng');
        } else {
            console.error('[AUTO] ‚ùå Kh√¥ng t√¨m th·∫•y n√∫t n·ªôp b√†i');
        }
    }

    function safeClick(el) {
        if (!el) return false;
        try {
            el.click();
            return true;
        } catch {
            const radio = el.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change', { bubbles: true }));
                radio.dispatchEvent(new Event('click', { bubbles: true }));
                return true;
            }
        }
        return false;
    }

    function initReviewPage() {
        console.log('[AUTO] üìñ ƒêang ·ªü trang ƒë√°p √°n - b·∫Øt ƒë·∫ßu qu√©t');

        setTimeout(() => {
            const answers = scanAnswers();
            console.log('[AUTO] ‚úÖ ƒê√£ qu√©t ƒë∆∞·ª£c', answers.length, 'ƒë√°p √°n:', answers);

            sessionStorage.setItem(ANSWER_KEY, JSON.stringify(answers));

            const practiceURL = sessionStorage.getItem('eduso_practice_url');
            if (practiceURL) {
                console.log('[AUTO] üîô Quay l·∫°i trang l√†m b√†i ƒë·ªÉ ƒëi·ªÅn ƒë√°p √°n:', practiceURL);
                sessionStorage.setItem('eduso_auto_fill', 'true');
                window.location.href = practiceURL;
            } else {
                console.error('[AUTO] ‚ùå Kh√¥ng t√¨m th·∫•y link trang l√†m b√†i ƒë√£ l∆∞u');
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y link trang l√†m b√†i');
            }
        }, 2000);
    }

    function scanAnswers() {
        const answers = [];
        const nodes = document.querySelectorAll('span.text-success, fillquiz i.text-success, fillquiz span.text-success');

        nodes.forEach(el => {
            let text = el.textContent.trim();
            if (!text || text.includes('Kh√¥ng c√≥')) return;
            if (text.includes('|')) text = text.split('|')[0].trim();

            if (el.tagName === 'SPAN' && /^[A-D][\.\)\s]/i.test(text)) {
                answers.push(text.charAt(0).toUpperCase() + ".");
            } else {
                answers.push(text);
            }
        });

        return answers;
    }

    // ================================================
    // COMPLETED LESSONS MANAGEMENT - TH√äM M·ªöI
    // ================================================
    function getCompletedLessons() {
        try {
            const data = sessionStorage.getItem(COMPLETED_KEY);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            return [];
        }
    }

    function markLessonAsCompleted(lessonTitle) {
        try {
            const completed = getCompletedLessons();
            if (!completed.includes(lessonTitle)) {
                completed.push(lessonTitle);
                sessionStorage.setItem(COMPLETED_KEY, JSON.stringify(completed));
                console.log('[AUTO] ‚úÖ ƒê√£ th√™m v√†o danh s√°ch ho√†n th√†nh:', lessonTitle);
            }
        } catch (e) {
            console.error('[AUTO] ‚ùå L·ªói khi ƒë√°nh d·∫•u b√†i ho√†n th√†nh:', e);
        }
    }

    function isLessonCompleted(lessonTitle) {
        const completed = getCompletedLessons();
        return completed.includes(lessonTitle);
    }

    function clearCompletedLessons() {
        sessionStorage.removeItem(COMPLETED_KEY);
        console.log('[AUTO] üßπ ƒê√£ x√≥a danh s√°ch b√†i ho√†n th√†nh');
    }

    // ================================================
    // STORAGE & HELPER FUNCTIONS
    // ================================================
    function saveState(state) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
            console.error('[AUTO] ‚ùå L·ªói l∆∞u state:', e);
        }
    }

    function getState() {
        try {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            return null;
        }
    }

    function clearState() {
        localStorage.removeItem(STORAGE_KEY);
        sessionStorage.removeItem('eduso_practice_url');
        sessionStorage.removeItem(ANSWER_KEY);
        sessionStorage.removeItem('eduso_auto_fill');
    }

    function delay(ms) {
        return new Promise(r => setTimeout(r, ms));
    }

})();
